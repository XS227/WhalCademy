<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø¨Ø§Ø²ÛŒ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ø¬Ø¯ÙˆÙ„ Ø¶Ø±Ø¨ | Ú©Ù„Ø§Ø³ Ø³ÙˆÙ…</title>
  <style>
    :root{
      --bg1:#0b1026;
      --bg2:#121a3a;
      --card: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.12);
      --stroke: rgba(255,255,255,.18);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --good: #31d0aa;
      --warn: #ffcc66;
      --bad: #ff6b8a;
      --accent: #7c5cff;
      --accent2:#00d4ff;
      --shadow: 0 18px 55px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 26px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Arabic", "Vazirmatn", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 70% 20%, rgba(124,92,255,.28), transparent 60%),
        radial-gradient(900px 550px at 20% 10%, rgba(0,212,255,.22), transparent 60%),
        radial-gradient(1000px 650px at 40% 90%, rgba(49,208,170,.18), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    /* subtle animated particles */
    .bg-particles{
      position:fixed; inset:0; pointer-events:none; opacity:.55;
      mask-image: radial-gradient(circle at center, rgba(0,0,0,1), rgba(0,0,0,.2) 65%, transparent 85%);
    }
    .dot{
      position:absolute; width:10px; height:10px; border-radius:999px;
      background:rgba(255,255,255,.12);
      filter: blur(.2px);
      animation: floaty 8s ease-in-out infinite;
    }
    @keyframes floaty{
      0%,100%{transform: translateY(0) translateX(0) scale(1); opacity:.35}
      50%{transform: translateY(-22px) translateX(12px) scale(1.15); opacity:.60}
    }

    .wrap{
      max-width:1080px;
      margin:0 auto;
      padding:18px 16px 46px;
    }

    header{
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      margin-top:8px;
      margin-bottom:14px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      background: linear-gradient(135deg, rgba(124,92,255,.22), rgba(0,212,255,.14));
      border:1px solid var(--stroke);
      border-radius: 999px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .logo{
      width:38px; height:38px; border-radius:12px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.25), transparent 40%),
        linear-gradient(135deg, rgba(124,92,255,.9), rgba(0,212,255,.85));
      display:grid; place-items:center;
      position:relative;
      overflow:hidden;
    }
    .logo::after{
      content:"âœ–";
      font-size:18px;
      opacity:.92;
      transform: rotate(-8deg);
      text-shadow: 0 8px 22px rgba(0,0,0,.35);
    }
    .brand h1{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
      line-height:1.2;
    }
    .brand p{
      margin:0;
      color:var(--muted);
      font-size:12px;
      line-height:1.1;
    }
    .top-actions{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .pill{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      display:flex; align-items:center; gap:10px;
      font-size:12px;
      color:var(--muted);
      user-select:none;
    }
    .pill b{color:var(--text); font-weight:700}

    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: linear-gradient(135deg, rgba(124,92,255,.14), rgba(0,212,255,.08));
    }
    .hd .ttl{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .badge{
      width:36px; height:36px;
      border-radius:14px;
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
    }
    .badge span{
      font-size:18px;
      transform: translateY(-1px);
      filter: drop-shadow(0 8px 16px rgba(0,0,0,.35));
    }
    .hd h2{
      margin:0;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .hd small{
      display:block;
      color:var(--muted);
      font-size:12px;
      margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .card .bd{padding:14px}
    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-bottom:12px;
    }
    .tab{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius: 999px;
      font-size:12px;
      cursor:pointer;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .tab:hover{transform: translateY(-1px)}
    .tab.active{
      background: linear-gradient(135deg, rgba(124,92,255,.35), rgba(0,212,255,.20));
      border-color: rgba(255,255,255,.30);
    }

    .panel{display:none}
    .panel.active{display:block}

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .controls{grid-template-columns:1fr}
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }
    select, input[type="number"], input[type="text"]{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    select:focus, input:focus{
      border-color: rgba(0,212,255,.55);
      box-shadow: 0 0 0 4px rgba(0,212,255,.12);
    }

    .btnrow{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:12px;
    }
    .btn{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:12px 14px;
      border-radius: 16px;
      cursor:pointer;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      display:flex; align-items:center; gap:10px;
      font-weight:700;
      font-size:12px;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(124,92,255,.55), rgba(0,212,255,.26));
      border-color: rgba(255,255,255,.28);
    }
    .btn.good{
      background: linear-gradient(135deg, rgba(49,208,170,.46), rgba(0,212,255,.16));
      border-color: rgba(49,208,170,.55);
    }
    .btn.warn{
      background: linear-gradient(135deg, rgba(255,204,102,.36), rgba(124,92,255,.16));
      border-color: rgba(255,204,102,.55);
    }
    .btn.danger{
      background: linear-gradient(135deg, rgba(255,107,138,.40), rgba(124,92,255,.16));
      border-color: rgba(255,107,138,.55);
    }
    .btn:active{transform: translateY(0px) scale(.99)}

    .stage{
      min-height: 520px;
      position:relative;
    }
    .stage-inner{
      padding:16px;
    }

    .big{
      font-size:34px;
      font-weight:900;
      letter-spacing:.2px;
      margin: 10px 0 6px;
      text-align:center;
    }
    .subtitle{
      text-align:center;
      color:var(--muted);
      font-size:13px;
      margin:0 0 14px;
    }

    .meter{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      margin: 12px 0 14px;
      flex-wrap:wrap;
    }
    .bar{
      flex:1;
      min-width:220px;
      height:12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      position:relative;
    }
    .bar > i{
      display:block;
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(49,208,170,.95), rgba(0,212,255,.75), rgba(124,92,255,.75));
      transition: width .35s ease;
    }
    .stat{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
      color:var(--muted);
      font-size:12px;
      user-select:none;
    }
    .stat b{color:var(--text)}
    .chip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      display:flex; gap:8px; align-items:center;
    }

    .question{
      margin-top:8px;
      display:grid;
      gap:12px;
      justify-items:center;
    }
    .bubble{
      width:min(640px, 100%);
      border-radius: 24px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      box-shadow: 0 16px 45px rgba(0,0,0,.30);
      padding:16px;
      position:relative;
      overflow:hidden;
    }
    .bubble::before{
      content:"";
      position:absolute;
      inset:-80px -60px auto auto;
      width:210px; height:210px;
      background: radial-gradient(circle at 30% 30%, rgba(0,212,255,.22), transparent 65%);
      transform: rotate(22deg);
      pointer-events:none;
    }
    .prompt{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      font-size:26px;
      font-weight:900;
      text-align:center;
    }
    .prompt .a, .prompt .b{
      display:inline-grid; place-items:center;
      min-width:52px;
      padding:6px 10px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.16);
      position:relative;
    }
    .prompt .sign{
      opacity:.9;
      font-size:20px;
      margin:0 4px;
    }

    .hint{
      margin-top:10px;
      text-align:center;
      color:var(--muted);
      font-size:12px;
    }

    .answerRow{
      width:min(640px, 100%);
      display:flex;
      gap:10px;
      align-items:stretch;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:2px;
    }
    .answerRow input{
      width: 180px;
      text-align:center;
      font-size:18px;
      font-weight:800;
    }
    .answerRow .btn{
      min-width:140px;
      justify-content:center;
    }

    .options{
      width:min(640px, 100%);
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin-top:8px;
    }
    @media (max-width: 720px){
      .options{grid-template-columns: repeat(2, 1fr)}
    }
    .opt{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      padding:14px 12px;
      text-align:center;
      font-weight:900;
      cursor:pointer;
      transition: transform .12s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      position:relative;
      overflow:hidden;
    }
    .opt:hover{transform: translateY(-1px)}
    .opt:active{transform: translateY(0px) scale(.99)}
    .opt.good{border-color: rgba(49,208,170,.65); background: rgba(49,208,170,.14)}
    .opt.bad{border-color: rgba(255,107,138,.65); background: rgba(255,107,138,.12)}

    .toast{
      position:absolute;
      left:14px; right:14px; bottom:14px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:12px 14px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.22);
      backdrop-filter: blur(12px);
      opacity:0;
      transform: translateY(10px);
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{
      opacity:1;
      transform: translateY(0);
    }
    .toast .msg{
      display:flex; align-items:center; gap:10px;
      color:var(--muted);
      font-size:12px;
    }
    .toast .msg b{color:var(--text)}
    .toast .mini{
      font-size:12px; color:var(--muted);
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      user-select:none;
    }

    /* Puzzle (match) */
    .matchGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      width:min(820px, 100%);
      margin: 0 auto;
    }
    @media (max-width: 820px){
      .matchGrid{grid-template-columns:1fr}
    }
    .col{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      border-radius: 22px;
      padding:12px;
    }
    .col h3{
      margin:0 0 10px;
      font-size:13px;
      color:var(--muted);
      display:flex; align-items:center; gap:8px;
    }
    .cards{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
    }
    @media (max-width: 420px){
      .cards{grid-template-columns:1fr}
    }
    .mcard{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      padding:12px 10px;
      font-weight:900;
      text-align:center;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, background .15s ease, border-color .15s ease;
      position:relative;
      overflow:hidden;
      min-height:54px;
      display:grid; place-items:center;
    }
    .mcard:hover{transform: translateY(-1px)}
    .mcard.selected{
      border-color: rgba(0,212,255,.7);
      background: rgba(0,212,255,.12);
      box-shadow: 0 18px 55px rgba(0,0,0,.25);
    }
    .mcard.matched{
      border-color: rgba(49,208,170,.65);
      background: rgba(49,208,170,.12);
      cursor:default;
      opacity:.9;
    }

    /* Achievements */
    .trophyRow{
      display:flex; gap:10px; flex-wrap:wrap;
      justify-content:center;
      margin-top:12px;
    }
    .trophy{
      padding:10px 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      display:flex; gap:10px; align-items:center;
      min-width: 160px;
      justify-content:center;
      user-select:none;
    }
    .trophy i{
      width:34px; height:34px;
      border-radius: 14px;
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.16);
      font-style:normal;
    }
    .trophy b{font-size:13px}
    .trophy small{display:block; color:var(--muted); font-size:12px}

    /* Confetti canvas */
    canvas#fx{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:30;
    }

    /* Motion helpers */
    .pop{
      animation: pop .28s ease;
    }
    @keyframes pop{
      0%{transform: scale(.96); filter:saturate(.9)}
      60%{transform: scale(1.02); filter:saturate(1.05)}
      100%{transform: scale(1)}
    }
    .shake{
      animation: shake .32s ease;
    }
    @keyframes shake{
      0%,100%{transform: translateX(0)}
      20%{transform: translateX(8px)}
      40%{transform: translateX(-7px)}
      60%{transform: translateX(6px)}
      80%{transform: translateX(-5px)}
    }

    .footerNote{
      margin-top:14px;
      color:var(--muted);
      font-size:12px;
      text-align:center;
      line-height:1.8;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:11px;
      padding:2px 6px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color:var(--text);
    }
  </style>
</head>

<body>
  <canvas id="fx"></canvas>

  <div class="bg-particles" id="particles"></div>

  <div class="wrap">
    <header>
      <div class="brand" title="Ø¨Ø§Ø²ÛŒ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ø¬Ø¯ÙˆÙ„ Ø¶Ø±Ø¨">
        <div class="logo"></div>
        <div>
          <h1>Ø¨Ø§Ø²ÛŒ Ø¬Ø¯ÙˆÙ„ Ø¶Ø±Ø¨ â€” Ú©Ù„Ø§Ø³ Ø³ÙˆÙ…</h1>
          <p>Ú©ÙˆÛŒÛŒØ² + Ù¾Ø§Ø²Ù„ + Ù…ÙˆØ´Ù† + Ù†Ø´Ø§Ù†â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒÙ Ù…Ø§Ù†Ø¯Ú¯Ø§Ø±</p>
        </div>
      </div>

      <div class="top-actions">
        <div class="pill" title="Ø§Ù…ØªÛŒØ§Ø² Ùˆ Ø³Ø·Ø­">
          <span>â­</span>
          <span>Ø§Ù…ØªÛŒØ§Ø²: <b id="scoreTop">0</b></span>
          <span style="opacity:.55">|</span>
          <span>Ø³Ø·Ø­: <b id="levelTop">1</b></span>
        </div>
        <div class="pill" title="Ø±Ú©ÙˆØ±Ø¯ Ø³Ø±Ø¹Øª">
          <span>âš¡</span>
          <span>Ø±Ú©ÙˆØ±Ø¯ Ø³Ø±Ø¹Øª: <b id="bestSpeedTop">â€”</b></span>
        </div>
      </div>
    </header>

    <div class="grid">

      <!-- Left: Settings -->
      <section class="card">
        <div class="hd">
          <div class="ttl">
            <div class="badge"><span>ğŸ§©</span></div>
            <div style="min-width:0">
              <h2>ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø§Ø²ÛŒ Ùˆ Ù…Ø³ÛŒØ± ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ</h2>
              <small>Ø§Ø² Ø³Ø§Ø¯Ù‡ Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯ Ùˆ Ú©Ù…â€ŒÚ©Ù… Ø³Ø®Øªâ€ŒØªØ± Ú©Ù†ÛŒØ¯</small>
            </div>
          </div>
        </div>

        <div class="bd">
          <div class="tabs" role="tablist" aria-label="Ø­Ø§Ù„Øªâ€ŒÙ‡Ø§">
            <button class="tab active" data-tab="quiz" role="tab">Ú©ÙˆÛŒÛŒØ² Ù‡ÙˆØ´Ù…Ù†Ø¯</button>
            <button class="tab" data-tab="speed" role="tab">Ø³Ø±Ø¹ØªÛŒ âš¡</button>
            <button class="tab" data-tab="match" role="tab">Ù¾Ø§Ø²Ù„ ØªØ·Ø¨ÛŒÙ‚</button>
          </div>

          <div class="panel active" id="tab-quiz" role="tabpanel">
            <div class="controls">
              <div>
                <label>Ø¬Ø¯ÙˆÙ„ Ù‡Ø¯Ù (Ù…Ø«Ù„Ø§Ù‹ 2 ÛŒØ§ 7 ÛŒØ§ Ù‡Ù…Ù‡)</label>
                <select id="tableSelect">
                  <option value="all">Ù‡Ù…Ù‡ Ø¬Ø¯ÙˆÙ„â€ŒÙ‡Ø§ (2 ØªØ§ 9)</option>
                  <option value="2">ÙÙ‚Ø· Ø¬Ø¯ÙˆÙ„ 2</option>
                  <option value="3">ÙÙ‚Ø· Ø¬Ø¯ÙˆÙ„ 3</option>
                  <option value="4">ÙÙ‚Ø· Ø¬Ø¯ÙˆÙ„ 4</option>
                  <option value="5">ÙÙ‚Ø· Ø¬Ø¯ÙˆÙ„ 5</option>
                  <option value="6">ÙÙ‚Ø· Ø¬Ø¯ÙˆÙ„ 6</option>
                  <option value="7">ÙÙ‚Ø· Ø¬Ø¯ÙˆÙ„ 7</option>
                  <option value="8">ÙÙ‚Ø· Ø¬Ø¯ÙˆÙ„ 8</option>
                  <option value="9">ÙÙ‚Ø· Ø¬Ø¯ÙˆÙ„ 9</option>
                </select>
              </div>
              <div>
                <label>Ø³Ø·Ø­ Ø³Ø®ØªÛŒ</label>
                <select id="difficulty">
                  <option value="easy">Ø¢Ø³Ø§Ù† (Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ + Ø±Ø§Ù‡Ù†Ù…Ø§)</option>
                  <option value="mix" selected>Ù…ØªÙˆØ³Ø· (Ú¯Ø§Ù‡ÛŒ Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ)</option>
                  <option value="hard">Ø³Ø®Øª (ÙˆØ±ÙˆØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ)</option>
                </select>
              </div>
              <div>
                <label>ØªØ¹Ø¯Ø§Ø¯ Ø³Ø¤Ø§Ù„ Ø¯Ø± Ù‡Ø± Ù…Ø±Ø­Ù„Ù‡</label>
                <input id="roundCount" type="number" min="5" max="30" value="10" />
              </div>
              <div>
                <label>Ø±Ø§Ù‡Ù†Ù…Ø§ (Ù†Ù…Ø§ÛŒØ´ Ø¨Ø§ Ø´Ú©Ù„â€ŒÙ‡Ø§)</label>
                <select id="visualHint">
                  <option value="on" selected>Ø±ÙˆØ´Ù† âœ…</option>
                  <option value="off">Ø®Ø§Ù…ÙˆØ´</option>
                </select>
              </div>
            </div>

            <div class="btnrow">
              <button class="btn primary" id="startQuizBtn">Ø´Ø±ÙˆØ¹ Ú©ÙˆÛŒÛŒØ² ğŸ¯</button>
              <button class="btn warn" id="resetBtn">Ø´Ø±ÙˆØ¹ Ø§Ø² Ù†Ùˆ ğŸ”„</button>
              <button class="btn" id="teacherBtn" title="Ù†Ú©ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÛŒØ¹ Ø¨Ø±Ø§ÛŒ Ù…Ø¹Ù„Ù…/ÙˆØ§Ù„Ø¯">Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø¬Ø±Ø§ ğŸ‘©â€ğŸ«</button>
            </div>

            <div class="footerNote">
              Ù†Ú©ØªÙ‡: Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ø§ <span class="kbd">Enter</span> Ø¬ÙˆØ§Ø¨ Ø±Ø§ Ø«Ø¨Øª Ú©Ù†Ø¯ØŒ Ùˆ Ø¨Ø§ <span class="kbd">Space</span> Ø³Ø¤Ø§Ù„ Ø¨Ø¹Ø¯ÛŒ Ø±Ø§ Ø¨Ú¯ÛŒØ±Ø¯.
            </div>
          </div>

          <div class="panel" id="tab-speed" role="tabpanel">
            <div class="controls">
              <div>
                <label>Ø²Ù…Ø§Ù† (Ø«Ø§Ù†ÛŒÙ‡)</label>
                <select id="speedTime">
                  <option value="20">20 Ø«Ø§Ù†ÛŒÙ‡</option>
                  <option value="30" selected>30 Ø«Ø§Ù†ÛŒÙ‡</option>
                  <option value="45">45 Ø«Ø§Ù†ÛŒÙ‡</option>
                  <option value="60">60 Ø«Ø§Ù†ÛŒÙ‡</option>
                </select>
              </div>
              <div>
                <label>Ø¬Ø¯ÙˆÙ„â€ŒÙ‡Ø§</label>
                <select id="speedTables">
                  <option value="all" selected>Ù‡Ù…Ù‡ (2 ØªØ§ 9)</option>
                  <option value="low">ÙÙ‚Ø· 2 ØªØ§ 5</option>
                  <option value="high">ÙÙ‚Ø· 6 ØªØ§ 9</option>
                </select>
              </div>
            </div>
            <div class="btnrow">
              <button class="btn good" id="startSpeedBtn">Ø´Ø±ÙˆØ¹ Ø³Ø±Ø¹ØªÛŒ âš¡</button>
              <button class="btn" id="stopSpeedBtn">ØªÙˆÙ‚Ù â¸</button>
            </div>
            <div class="footerNote">
              Ù‡Ø¯Ù: Ø¯Ø± Ø²Ù…Ø§Ù† Ú©Ù…ØŒ ØªØ¹Ø¯Ø§Ø¯ Ø¨ÛŒØ´ØªØ±ÛŒ Ø¬ÙˆØ§Ø¨ Ø¯Ø±Ø³Øª Ø¨Ø¯Ù‡ÛŒÙ…. Ø§Ú¯Ø± Ø§Ø´ØªØ¨Ø§Ù‡ Ø´Ø¯ØŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ù‡Ù…Ø§Ù† Ù†ÙˆØ¹ Ø³Ø¤Ø§Ù„ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯.
            </div>
          </div>

          <div class="panel" id="tab-match" role="tabpanel">
            <div class="controls">
              <div>
                <label>Ø¬Ø¯ÙˆÙ„ Ù¾Ø§Ø²Ù„</label>
                <select id="matchTable">
                  <option value="2">Ù¾Ø§Ø²Ù„ Ø¬Ø¯ÙˆÙ„ 2</option>
                  <option value="3">Ù¾Ø§Ø²Ù„ Ø¬Ø¯ÙˆÙ„ 3</option>
                  <option value="4">Ù¾Ø§Ø²Ù„ Ø¬Ø¯ÙˆÙ„ 4</option>
                  <option value="5" selected>Ù¾Ø§Ø²Ù„ Ø¬Ø¯ÙˆÙ„ 5</option>
                  <option value="6">Ù¾Ø§Ø²Ù„ Ø¬Ø¯ÙˆÙ„ 6</option>
                  <option value="7">Ù¾Ø§Ø²Ù„ Ø¬Ø¯ÙˆÙ„ 7</option>
                  <option value="8">Ù¾Ø§Ø²Ù„ Ø¬Ø¯ÙˆÙ„ 8</option>
                  <option value="9">Ù¾Ø§Ø²Ù„ Ø¬Ø¯ÙˆÙ„ 9</option>
                </select>
              </div>
              <div>
                <label>ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§</label>
                <select id="matchCount">
                  <option value="6">6 Ú©Ø§Ø±Øª (Ø®ÛŒÙ„ÛŒ Ø¢Ø³Ø§Ù†)</option>
                  <option value="8" selected>8 Ú©Ø§Ø±Øª (Ø¢Ø³Ø§Ù†)</option>
                  <option value="10">10 Ú©Ø§Ø±Øª (Ù…ØªÙˆØ³Ø·)</option>
                  <option value="12">12 Ú©Ø§Ø±Øª (Ú†Ø§Ù„Ø´â€ŒØ¯Ø§Ø±)</option>
                </select>
              </div>
            </div>
            <div class="btnrow">
              <button class="btn primary" id="startMatchBtn">Ø³Ø§Ø®Øª Ù¾Ø§Ø²Ù„ ğŸ§©</button>
              <button class="btn" id="reshuffleMatchBtn">Ø¯Ø±Ù‡Ù…â€ŒØ±ÛŒØ²ÛŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ğŸ²</button>
            </div>
            <div class="footerNote">
              Ø±ÙˆØ´ Ø¨Ø§Ø²ÛŒ: ÛŒÚ© Ú©Ø§Ø±Øª Â«Ø¹Ø¨Ø§Ø±ØªÂ» Ùˆ ÛŒÚ© Ú©Ø§Ø±Øª Â«Ø¬ÙˆØ§Ø¨Â» Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ù† ØªØ§ Ø¬ÙØª Ø´ÙˆÙ†Ø¯.
            </div>
          </div>

        </div>
      </section>

      <!-- Right: Stage -->
      <section class="card stage" aria-live="polite">
        <div class="hd">
          <div class="ttl">
            <div class="badge"><span id="modeIcon">ğŸ¯</span></div>
            <div style="min-width:0">
              <h2 id="modeTitle">Ú©ÙˆÛŒÛŒØ² Ù‡ÙˆØ´Ù…Ù†Ø¯</h2>
              <small id="modeDesc">Ø¨Ø§ Ø³ÙˆØ§Ù„â€ŒÙ‡Ø§ÛŒ Ú©ÙˆØªØ§Ù‡ Ùˆ Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ ÙÙˆØ±ÛŒ ÛŒØ§Ø¯ Ø¨Ú¯ÛŒØ±</small>
            </div>
          </div>
          <div class="pill" title="Ø²Ù…Ø§Ù† / Ù…Ø±Ø­Ù„Ù‡">
            <span id="clockIcon">â±</span>
            <span><b id="timeTxt">â€”</b></span>
          </div>
        </div>

        <div class="stage-inner" id="stage">
          <div class="big">Ø³Ù„Ø§Ù… Ù‚Ù‡Ø±Ù…Ø§Ù† Ø¶Ø±Ø¨!</div>
          <p class="subtitle">ÛŒÚ© Ø­Ø§Ù„Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† Ùˆ Ø´Ø±ÙˆØ¹ Ú©Ù†. Ù‡Ø± Ø¬ÙˆØ§Ø¨ Ø¯Ø±Ø³ØªØŒ Ø³ØªØ§Ø±Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.</p>

          <div class="trophyRow">
            <div class="trophy"><i>â­</i><div><b>Ø³ØªØ§Ø±Ù‡â€ŒÙ‡Ø§</b><small id="starsTxt">0</small></div></div>
            <div class="trophy"><i>ğŸ…</i><div><b>Ù†Ø´Ø§Ù†â€ŒÙ‡Ø§</b><small id="badgeTxt">0</small></div></div>
            <div class="trophy"><i>ğŸ“ˆ</i><div><b>Ù¾ÛŒØ´Ø±ÙØª</b><small id="progressTxt">0%</small></div></div>
          </div>

          <div class="footerNote" style="margin-top:18px">
            Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¢Ù…ÙˆØ²Ø´ÛŒ: Ø§Ø¨ØªØ¯Ø§ Ø¬Ø¯ÙˆÙ„â€ŒÙ‡Ø§ÛŒ 2 Ùˆ 5 (Ø§Ù„Ú¯ÙˆÙ‡Ø§)ØŒ Ø³Ù¾Ø³ 3 Ùˆ 4ØŒ Ø¨Ø¹Ø¯ 6 ØªØ§ 9.
          </div>
        </div>

        <div class="toast" id="toast">
          <div class="msg" id="toastMsg"><b>Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§ÛŒØŸ</b> Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒÙ…!</div>
          <div class="mini" id="toastMini">Ø±Ø§Ù‡Ù†Ù…Ø§</div>
        </div>
      </section>

    </div>
  </div>

<script>
(function(){
  // ---------- helpers ----------
  const $ = (q,el=document)=>el.querySelector(q);
  const $$ = (q,el=document)=>Array.from(el.querySelectorAll(q));
  const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
  const rnd = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const shuffle = (arr)=>arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);

  // ---------- persistent state ----------
  const storeKey="zarb_game_v1";
  const saved = JSON.parse(localStorage.getItem(storeKey)||"{}");
  const state = {
    score: saved.score||0,
    stars: saved.stars||0,
    badges: saved.badges||0,
    level: saved.level||1,
    bestSpeed: saved.bestSpeed||null, // number correct
    seen: saved.seen||{}, // "aÃ—b": {right, wrong, last}
    // session
    mode: "quiz",
    roundTotal: 10,
    roundDone: 0,
    roundRight: 0,
    current: null,
    allowNext: false,
    speed: {running:false, endAt:0, right:0, wrong:0, timer:null},
    match: {pairs:[], selectedL:null, selectedR:null, matched:0}
  };

  function persist(){
    const out = {
      score: state.score,
      stars: state.stars,
      badges: state.badges,
      level: state.level,
      bestSpeed: state.bestSpeed,
      seen: state.seen
    };
    localStorage.setItem(storeKey, JSON.stringify(out));
  }

  // ---------- UI refs ----------
  const scoreTop=$("#scoreTop"), levelTop=$("#levelTop"), bestSpeedTop=$("#bestSpeedTop");
  const starsTxt=$("#starsTxt"), badgeTxt=$("#badgeTxt"), progressTxt=$("#progressTxt");
  const modeIcon=$("#modeIcon"), modeTitle=$("#modeTitle"), modeDesc=$("#modeDesc");
  const timeTxt=$("#timeTxt"), clockIcon=$("#clockIcon");
  const stage=$("#stage");
  const toast=$("#toast"), toastMsg=$("#toastMsg"), toastMini=$("#toastMini");

  // controls
  const tableSelect=$("#tableSelect");
  const difficulty=$("#difficulty");
  const roundCount=$("#roundCount");
  const visualHint=$("#visualHint");
  const startQuizBtn=$("#startQuizBtn");
  const resetBtn=$("#resetBtn");
  const teacherBtn=$("#teacherBtn");

  const speedTime=$("#speedTime");
  const speedTables=$("#speedTables");
  const startSpeedBtn=$("#startSpeedBtn");
  const stopSpeedBtn=$("#stopSpeedBtn");

  const matchTable=$("#matchTable");
  const matchCount=$("#matchCount");
  const startMatchBtn=$("#startMatchBtn");
  const reshuffleMatchBtn=$("#reshuffleMatchBtn");

  // tabs
  $$(".tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      $$(".tab").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const tab = btn.dataset.tab;
      $$(".panel").forEach(p=>p.classList.remove("active"));
      $("#tab-"+tab).classList.add("active");
      switchMode(tab);
    });
  });

  // particles
  (function buildParticles(){
    const box=$("#particles");
    const N=16;
    for(let i=0;i<N;i++){
      const d=document.createElement("div");
      d.className="dot";
      const x=Math.random()*100, y=Math.random()*100;
      d.style.left=x+"%";
      d.style.top=y+"%";
      d.style.animationDelay=(Math.random()*4)+"s";
      d.style.animationDuration=(6+Math.random()*6)+"s";
      d.style.transform=`translateZ(0) scale(${0.8+Math.random()*1.6})`;
      box.appendChild(d);
    }
  })();

  // ---------- confetti ----------
  const fx=$("#fx");
  const ctx=fx.getContext("2d");
  let confetti=[];
  function resizeFx(){
    fx.width = window.innerWidth * devicePixelRatio;
    fx.height = window.innerHeight * devicePixelRatio;
  }
  window.addEventListener("resize", resizeFx);
  resizeFx();

  function burstConfetti(power=120){
    const w=fx.width, h=fx.height;
    const cx = w*0.5, cy = h*0.28;
    for(let i=0;i<power;i++){
      confetti.push({
        x: cx + rnd(-80,80),
        y: cy + rnd(-30,30),
        vx: (Math.random()*2-1) * rnd(4,12) * devicePixelRatio,
        vy: (Math.random()*-1) * rnd(6,16) * devicePixelRatio,
        g: rnd(18,26) * devicePixelRatio * 0.06,
        r: rnd(3,6) * devicePixelRatio,
        a: 1
      });
    }
  }
  function tickFx(){
    ctx.clearRect(0,0,fx.width,fx.height);
    confetti = confetti.filter(p=>p.a>0);
    for(const p of confetti){
      p.vy += p.g;
      p.x += p.vx;
      p.y += p.vy;
      p.a -= 0.012;
      ctx.globalAlpha = clamp(p.a,0,1);
      // no explicit colors: derive grayscale-ish + alpha; keep simple
      ctx.fillStyle = "rgba(255,255,255,"+clamp(p.a,0,1)+")";
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha=1;
    requestAnimationFrame(tickFx);
  }
  tickFx();

  // ---------- scoring & leveling ----------
  function updateTop(){
    scoreTop.textContent = state.score;
    levelTop.textContent = state.level;
    bestSpeedTop.textContent = state.bestSpeed==null ? "â€”" : (state.bestSpeed + " Ø¯Ø±Ø³Øª");
    starsTxt.textContent = state.stars;
    badgeTxt.textContent = state.badges;
    progressTxt.textContent = progressPercent()+"%";
  }
  function progressPercent(){
    // heuristic: based on unique facts with >=3 right and <=1 wrong
    const keys = Object.keys(state.seen);
    if(keys.length===0) return 0;
    let good=0;
    keys.forEach(k=>{
      const it=state.seen[k];
      if((it.right||0) >= 3 && (it.wrong||0) <= 1) good++;
    });
    return Math.round((good/Math.max(30,keys.length))*100); // normalize
  }
  function addScore(points){
    state.score += points;
    state.stars += Math.max(0, Math.floor(points/10));
    // level up each 120 points
    const newLevel = Math.floor(state.score/120)+1;
    if(newLevel>state.level){
      state.level=newLevel;
      state.badges += 1;
      burstConfetti(150);
      showToast("ğŸ… Ø³Ø·Ø­ Ø¬Ø¯ÛŒØ¯ Ú¯Ø±ÙØªÛŒ!", "Ø³Ø·Ø­ "+state.level);
    }
    updateTop();
    persist();
  }

  // ---------- toast ----------
  let toastTimer=null;
  function showToast(text, mini="Ø±Ø§Ù‡Ù†Ù…Ø§", ms=1400){
    toastMsg.innerHTML = text;
    toastMini.textContent = mini;
    toast.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer=setTimeout(()=>toast.classList.remove("show"), ms);
  }

  // ---------- question generation (light spaced repetition) ----------
  function pickTables(){
    const v = tableSelect.value;
    if(v==="all") return [2,3,4,5,6,7,8,9];
    return [parseInt(v,10)];
  }

  function weightFor(a,b){
    const key=`${a}x${b}`;
    const it=state.seen[key]||{right:0,wrong:0,last:0};
    // more weight if wrong or not seen; less if mastered
    const r=it.right||0, w=it.wrong||0;
    const age = Date.now() - (it.last||0);
    const ageBoost = clamp(age/(1000*60*5), 0, 2); // up to +2 after ~10min
    let base = 3 + w*3 - r*1.2 + ageBoost;
    if(r>=4 && w===0) base *= 0.35;
    return clamp(base, 0.2, 12);
  }

  function nextQuestionFromPool(pool){
    const weights = pool.map(q=>weightFor(q.a,q.b));
    const sum = weights.reduce((s,x)=>s+x,0);
    let t = Math.random()*sum;
    for(let i=0;i<pool.length;i++){
      t -= weights[i];
      if(t<=0) return pool[i];
    }
    return pool[pool.length-1];
  }

  function buildPool(tables){
    const pool=[];
    // for grade 3: multiply by 1..10 (we include 0? no)
    tables.forEach(a=>{
      for(let b=1;b<=10;b++){
        pool.push({a,b,ans:a*b});
      }
    });
    return pool;
  }

  function makeDistractors(ans){
    const set = new Set([ans]);
    while(set.size<4){
      const delta = rnd(-6,6);
      const v = clamp(ans + delta + rnd(-2,2), 0, 99);
      if(v!==ans) set.add(v);
    }
    return shuffle(Array.from(set)).slice(0,4);
  }

  // ---------- renderers ----------
  function renderQuizIntro(){
    stage.innerHTML = `
      <div class="big pop">Ú©ÙˆÛŒÛŒØ² Ù‡ÙˆØ´Ù…Ù†Ø¯</div>
      <p class="subtitle">Ø³Ø¤Ø§Ù„â€ŒÙ‡Ø§ Ø¨Ø§ ØªÙˆØ¬Ù‡ Ø¨Ù‡ Ø§Ø´ØªØ¨Ø§Ù‡â€ŒÙ‡Ø§ Ùˆ ØªÙ…Ø±ÛŒÙ†â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</p>
      <div class="trophyRow">
        <div class="trophy"><i>â­</i><div><b>Ø§Ù…ØªÛŒØ§Ø²</b><small>${state.score}</small></div></div>
        <div class="trophy"><i>ğŸ§ </i><div><b>ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ</b><small>Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ ÙÙˆØ±ÛŒ</small></div></div>
        <div class="trophy"><i>ğŸ¯</i><div><b>Ù‡Ø¯Ù</b><small>Ø¯Ø±Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒâ€ŒØ¯Ø±Ù¾ÛŒ</small></div></div>
      </div>
      <div class="footerNote" style="margin-top:16px">
        Ù†Ú©ØªÙ‡: Ø§Ú¯Ø± Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø§Ø´ØªØ¨Ø§Ù‡ Ú©Ù†Ø¯ØŒ Ù‡Ù…Ø§Ù† Ù†ÙˆØ¹ Ø³Ø¤Ø§Ù„ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø§ ÙØ§ØµÙ„Ù‡ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯ ØªØ§ Ø¬Ø§ Ø¨ÛŒÙØªØ¯.
      </div>
    `;
    timeTxt.textContent="â€”";
    clockIcon.textContent="â±";
  }

  function renderSpeedIntro(){
    stage.innerHTML = `
      <div class="big pop">Ø­Ø§Ù„Øª Ø³Ø±Ø¹ØªÛŒ âš¡</div>
      <p class="subtitle">Ø¯Ø± Ø²Ù…Ø§Ù† Ù…Ø­Ø¯ÙˆØ¯ØŒ Ù‡Ø± Ø¬ÙˆØ§Ø¨ Ø¯Ø±Ø³Øª ÛŒÚ© Ø§Ù…ØªÛŒØ§Ø² Ø®ÙˆØ¨ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.</p>
      <div class="trophyRow">
        <div class="trophy"><i>âš¡</i><div><b>ØªÙ…Ø±Ú©Ø²</b><small>Ø²ÙˆØ¯ Ùˆ Ø¯Ø±Ø³Øª</small></div></div>
        <div class="trophy"><i>â³</i><div><b>Ø²Ù…Ø§Ù†</b><small>Ú†Ø§Ù„Ø´â€ŒØ¨Ø±Ø§Ù†Ú¯ÛŒØ²</small></div></div>
        <div class="trophy"><i>ğŸ</i><div><b>Ø±Ú©ÙˆØ±Ø¯</b><small>${state.bestSpeed==null?"â€”":state.bestSpeed+" Ø¯Ø±Ø³Øª"}</small></div></div>
      </div>
      <div class="footerNote" style="margin-top:16px">
        Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ø§ÙˆÙ„ 30 Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø§ Ø¬Ø¯ÙˆÙ„â€ŒÙ‡Ø§ÛŒ 2 ØªØ§ 5ØŒ Ø¨Ø¹Ø¯ Ø³Ø±Ø§Øº Ù‡Ù…Ù‡ Ø¬Ø¯ÙˆÙ„â€ŒÙ‡Ø§.
      </div>
    `;
    timeTxt.textContent="â€”";
    clockIcon.textContent="â±";
  }

  function renderMatchIntro(){
    stage.innerHTML = `
      <div class="big pop">Ù¾Ø§Ø²Ù„ ØªØ·Ø¨ÛŒÙ‚ ğŸ§©</div>
      <p class="subtitle">Ø¹Ø¨Ø§Ø±Øª Ø±Ø§ Ø¨Ø§ Ø¬ÙˆØ§Ø¨ Ø¯Ø±Ø³Øª Ø¬ÙØª Ú©Ù† ØªØ§ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ Ù‚ÙÙ„ Ø´ÙˆÙ†Ø¯.</p>
      <div class="trophyRow">
        <div class="trophy"><i>ğŸ§©</i><div><b>Ø­Ø§ÙØ¸Ù‡</b><small>Ø¬ÙØªâ€ŒØ³Ø§Ø²ÛŒ</small></div></div>
        <div class="trophy"><i>ğŸ‘€</i><div><b>Ø¯Ù‚Øª</b><small>Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø§Ù„Ú¯Ùˆ</small></div></div>
        <div class="trophy"><i>ğŸ‰</i><div><b>Ø¬Ø§ÛŒØ²Ù‡</b><small>Ù‚ÙÙ„ Ø´Ø¯Ù† Ø¬ÙØªâ€ŒÙ‡Ø§</small></div></div>
      </div>
      <div class="footerNote" style="margin-top:16px">
        Ù†Ú©ØªÙ‡: Ø¨Ø±Ø§ÛŒ Ú©Ù„Ø§Ø³ØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ù‡Ø§ Ø±Ø§ Ø¯Ùˆ ØªÛŒÙ… Ú©Ù†ÛŒØ¯ Ùˆ Ù‡Ø± Ø¬ÙØªÙ Ø¯Ø±Ø³Øª ÛŒÚ© Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø§Ø´Ø¯.
      </div>
    `;
    timeTxt.textContent="â€”";
    clockIcon.textContent="â±";
  }

  function switchMode(m){
    state.mode=m;
    state.allowNext=false;
    // stop speed timer if switching
    stopSpeed();

    if(m==="quiz"){
      modeIcon.textContent="ğŸ¯";
      modeTitle.textContent="Ú©ÙˆÛŒÛŒØ² Ù‡ÙˆØ´Ù…Ù†Ø¯";
      modeDesc.textContent="Ø³ÙˆØ§Ù„â€ŒÙ‡Ø§ÛŒ Ù‡Ø¯ÙÙ…Ù†Ø¯ + Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ ÙÙˆØ±ÛŒ";
      renderQuizIntro();
    }else if(m==="speed"){
      modeIcon.textContent="âš¡";
      modeTitle.textContent="Ø­Ø§Ù„Øª Ø³Ø±Ø¹ØªÛŒ";
      modeDesc.textContent="Ø¯Ø± Ø²Ù…Ø§Ù† Ú©Ù…ØŒ Ø¯Ø±Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø¨ÛŒØ´ØªØ±";
      renderSpeedIntro();
    }else{
      modeIcon.textContent="ğŸ§©";
      modeTitle.textContent="Ù¾Ø§Ø²Ù„ ØªØ·Ø¨ÛŒÙ‚";
      modeDesc.textContent="Ø¹Ø¨Ø§Ø±Øª Ùˆ Ø¬ÙˆØ§Ø¨ Ø±Ø§ Ø¬ÙØª Ú©Ù†";
      renderMatchIntro();
    }
  }

  // ---------- QUIZ mode ----------
  let quizPool = [];
  function startQuiz(){
    const tables = pickTables();
    quizPool = buildPool(tables);
    state.roundTotal = clamp(parseInt(roundCount.value,10)||10, 5, 30);
    state.roundDone=0; state.roundRight=0;
    state.allowNext=false;
    showToast("ğŸ¯ Ø´Ø±ÙˆØ¹ Ø´Ø¯! Ù‡Ø± Ø¬ÙˆØ§Ø¨ Ø¯Ø±Ø³Øª ÛŒÚ© Ø³ØªØ§Ø±Ù‡ Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±.", "Ú©ÙˆÛŒÛŒØ²");
    nextQuizQuestion();
  }

  function visualDots(count){
    // show groups of 5 with symbols to avoid heavy DOM
    const sym = ["ğŸ","â­","ğŸ”·","ğŸŒ¼"][rnd(0,3)];
    const n = clamp(count,0,60);
    let s="";
    for(let i=1;i<=n;i++){
      s += sym;
      if(i%5===0) s += " ";
      if(i%20===0) s += "<br>";
    }
    return s || "â€”";
  }

  function renderQuizQuestion(q){
    const diff = difficulty.value;
    const useOptions =
      (diff==="easy") ? true :
      (diff==="mix") ? (Math.random()<0.6) :
      false;

    const hintOn = (visualHint.value==="on");
    const options = makeDistractors(q.ans);

    const progress = Math.round((state.roundDone/state.roundTotal)*100);
    timeTxt.textContent = `Ù…Ø±Ø­Ù„Ù‡: ${state.roundDone+1} Ø§Ø² ${state.roundTotal}`;
    clockIcon.textContent="ğŸ“";

    stage.innerHTML = `
      <div class="big pop">Ø³Ø¤Ø§Ù„ ${state.roundDone+1}</div>
      <p class="subtitle">Ø¨Ù‡â€ŒØ¢Ø±Ø§Ù…ÛŒ ÙÚ©Ø± Ú©Ù†: ${q.a} ØªØ§ ${q.b} ØªØ§ ÛŒØ¹Ù†ÛŒ Ú†Ù†Ø¯ØªØ§ØŸ</p>

      <div class="meter">
        <div class="bar" aria-label="Ù†ÙˆØ§Ø± Ù¾ÛŒØ´Ø±ÙØª"><i style="width:${progress}%"></i></div>
        <div class="stat">
          <span class="chip">âœ… Ø¯Ø±Ø³Øª: <b>${state.roundRight}</b></span>
          <span class="chip">ğŸ§  Ø³Ø·Ø­: <b>${state.level}</b></span>
          <span class="chip">â­ Ø§Ù…ØªÛŒØ§Ø²: <b>${state.score}</b></span>
        </div>
      </div>

      <div class="question">
        <div class="bubble pop">
          <div class="prompt" aria-label="ØµÙˆØ±Øª Ø³ÙˆØ§Ù„">
            <span class="a">${q.a}</span>
            <span class="sign">Ã—</span>
            <span class="b">${q.b}</span>
            <span class="sign">=</span>
            <span style="opacity:.85">ØŸ</span>
          </div>

          ${hintOn ? `
            <div class="hint">
              Ø±Ø§Ù‡Ù†Ù…Ø§: ${q.a} Ú¯Ø±ÙˆÙ‡Ù ${q.b}ØªØ§ÛŒÛŒ â†’ <span style="display:inline-block; padding:6px 10px; border-radius:14px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.14); margin-top:8px">
                ${visualDots(Math.min(q.ans,40))}
              </span>
            </div>
          ` : `<div class="hint">Ø±Ø§Ù‡Ù†Ù…Ø§ Ø®Ø§Ù…ÙˆØ´ Ø§Ø³Øª</div>`}
        </div>

        ${useOptions ? `
          <div class="options" id="opts" aria-label="Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§">
            ${options.map(v=>`<div class="opt" data-v="${v}">${v}</div>`).join("")}
          </div>
          <div class="answerRow" style="margin-top:2px">
            <button class="btn primary" id="nextBtn" disabled style="opacity:.55; cursor:not-allowed">Ø³Ø¤Ø§Ù„ Ø¨Ø¹Ø¯ÛŒ âœ</button>
          </div>
        ` : `
          <div class="answerRow">
            <input id="ansInput" inputmode="numeric" autocomplete="off" placeholder="Ø¬ÙˆØ§Ø¨ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³" />
            <button class="btn primary" id="checkBtn">Ø¨Ø±Ø±Ø³ÛŒ âœ…</button>
            <button class="btn" id="skipBtn" title="Ø§Ú¯Ø± Ù†Ù…ÛŒâ€ŒØ¯Ø§Ù†ÛŒØŒ Ø¬ÙˆØ§Ø¨ Ø±Ø§ Ø¨Ø¨ÛŒÙ† Ùˆ Ø¨Ø±Ùˆ Ø¨Ø¹Ø¯ÛŒ">Ù†Ù…ÛŒâ€ŒØ¯Ø§Ù†Ù… ğŸ¤”</button>
          </div>
        `}
      </div>

      <div class="footerNote">
        Ù†Ú©ØªÙ‡: Ø¶Ø±Ø¨ ÛŒØ¹Ù†ÛŒ Â«Ú†Ù†Ø¯ Ú¯Ø±ÙˆÙ‡ Ù…Ø³Ø§ÙˆÛŒÂ». Ø¨Ù‡ Ø§Ù„Ú¯ÙˆÙ‡Ø§ Ø¯Ù‚Øª Ú©Ù† (Ù…Ø«Ù„ Ø¬Ø¯ÙˆÙ„ 5 Ú©Ù‡ Ù‡Ù…ÛŒØ´Ù‡ Ø¨Ù‡ 0 ÛŒØ§ 5 Ø®ØªÙ… Ù…ÛŒâ€ŒØ´ÙˆØ¯).
      </div>
    `;

    if(useOptions){
      const opts=$("#opts");
      const nextBtn=$("#nextBtn");
      opts.addEventListener("click", (e)=>{
        const t=e.target.closest(".opt");
        if(!t || state.allowNext) return;
        const v=parseInt(t.dataset.v,10);
        const ok = (v===q.ans);
        $$(".opt",opts).forEach(x=>x.style.pointerEvents="none");
        $$(".opt",opts).forEach(x=>{
          const vv=parseInt(x.dataset.v,10);
          if(vv===q.ans) x.classList.add("good");
          else if(vv===v && !ok) x.classList.add("bad");
        });
        onAnswered(ok, q, v);
        state.allowNext=true;
        nextBtn.disabled=false;
        nextBtn.style.opacity="1";
        nextBtn.style.cursor="pointer";
        nextBtn.classList.add("pop");
        nextBtn.addEventListener("click", ()=> nextQuizQuestion(), {once:true});
      });
    }else{
      const input=$("#ansInput");
      const check=$("#checkBtn");
      const skip=$("#skipBtn");
      input.focus();

      function submit(){
        if(state.allowNext) return;
        const v = parseInt((input.value||"").trim(),10);
        if(Number.isNaN(v)){
          stage.classList.remove("shake"); void stage.offsetWidth; stage.classList.add("shake");
          showToast("Ø¹Ø¯Ø¯ ÙˆØ§Ø±Ø¯ Ú©Ù† ğŸ‘€", "Ø±Ø§Ù‡Ù†Ù…Ø§");
          return;
        }
        const ok = (v===q.ans);
        onAnswered(ok, q, v);
        state.allowNext=true;
        // show next
        const row=document.createElement("div");
        row.className="answerRow";
        row.innerHTML = `<button class="btn good pop" id="nextBtn2">Ø³Ø¤Ø§Ù„ Ø¨Ø¹Ø¯ÛŒ âœ</button>`;
        $(".question").appendChild(row);
        $("#nextBtn2").addEventListener("click", ()=> nextQuizQuestion(), {once:true});
      }

      check.addEventListener("click", submit);
      skip.addEventListener("click", ()=>{
        if(state.allowNext) return;
        onAnswered(false, q, null, true);
        state.allowNext=true;
        const row=document.createElement("div");
        row.className="answerRow";
        row.innerHTML = `<button class="btn good pop" id="nextBtn2">Ø³Ø¤Ø§Ù„ Ø¨Ø¹Ø¯ÛŒ âœ</button>`;
        $(".question").appendChild(row);
        $("#nextBtn2").addEventListener("click", ()=> nextQuizQuestion(), {once:true});
      });

      document.addEventListener("keydown", keyHandlerOnce);
      function keyHandlerOnce(ev){
        if(state.mode!=="quiz") { document.removeEventListener("keydown", keyHandlerOnce); return; }
        if(ev.key==="Enter"){ submit(); }
        if(ev.code==="Space" && state.allowNext){ nextQuizQuestion(); }
      }
    }
  }

  function markSeen(q, ok){
    const key=`${q.a}x${q.b}`;
    const it = state.seen[key] || {right:0,wrong:0,last:0};
    it.last = Date.now();
    if(ok) it.right = (it.right||0)+1;
    else it.wrong = (it.wrong||0)+1;
    state.seen[key]=it;
    persist();
  }

  function onAnswered(ok, q, userV, skipped=false){
    markSeen(q, ok);
    state.roundDone += 1;
    if(ok){
      state.roundRight += 1;
      addScore(18);
      burstConfetti(90);
      showToast("âœ… Ø¢ÙØ±ÛŒÙ†! Ø¯Ø±Ø³Øª Ø¨ÙˆØ¯.", `+18 Ø§Ù…ØªÛŒØ§Ø²`);
    }else{
      // show correct answer
      addScore(4);
      const msg = skipped
        ? `ğŸ¤” Ø§Ø´Ú©Ø§Ù„ Ù†Ø¯Ø§Ø±Ø¯. Ø¬ÙˆØ§Ø¨: <b>${q.a}Ã—${q.b} = ${q.ans}</b>`
        : `âŒ Ù†Ø²Ø¯ÛŒÚ© Ø¨ÙˆØ¯. Ø¬ÙˆØ§Ø¨ Ø¯Ø±Ø³Øª: <b>${q.a}Ã—${q.b} = ${q.ans}</b>`;
      showToast(msg, "+4 Ø§Ù…ØªÛŒØ§Ø²");
      stage.classList.remove("shake"); void stage.offsetWidth; stage.classList.add("shake");
    }
    updateTop();
  }

  function nextQuizQuestion(){
    state.allowNext=false;
    if(state.roundDone >= state.roundTotal){
      endQuiz();
      return;
    }
    const q = nextQuestionFromPool(quizPool);
    state.current = q;
    renderQuizQuestion(q);
  }

  function endQuiz(){
    const pct = Math.round((state.roundRight/state.roundTotal)*100);
    const bonus = (pct>=80) ? 60 : (pct>=60 ? 35 : 18);
    addScore(bonus);
    burstConfetti(pct>=80 ? 180 : 110);
    stage.innerHTML = `
      <div class="big pop">Ù¾Ø§ÛŒØ§Ù† Ù…Ø±Ø­Ù„Ù‡ ğŸ‰</div>
      <p class="subtitle">Ù†ØªÛŒØ¬Ù‡: <b>${state.roundRight}</b> Ø¯Ø±Ø³Øª Ø§Ø² <b>${state.roundTotal}</b> â€” ${pct}%</p>

      <div class="trophyRow">
        <div class="trophy"><i>âœ…</i><div><b>Ø¯Ø±Ø³Øªâ€ŒÙ‡Ø§</b><small>${state.roundRight}</small></div></div>
        <div class="trophy"><i>ğŸ</i><div><b>Ø¬Ø§ÛŒØ²Ù‡</b><small>+${bonus} Ø§Ù…ØªÛŒØ§Ø²</small></div></div>
        <div class="trophy"><i>ğŸ“ˆ</i><div><b>Ù¾ÛŒØ´Ø±ÙØª</b><small>${progressPercent()}%</small></div></div>
      </div>

      <div class="btnrow" style="justify-content:center; margin-top:16px">
        <button class="btn primary" id="againBtn">ÛŒÚ© Ù…Ø±Ø­Ù„Ù‡ Ø¯ÛŒÚ¯Ø± ğŸ¯</button>
        <button class="btn" id="reviewBtn">Ù…Ø±ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡â€ŒÙ‡Ø§ ğŸ”</button>
      </div>

      <div class="footerNote">
        Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ø§Ú¯Ø± Ø¯Ø±ØµØ¯ Ù¾Ø§ÛŒÛŒÙ† Ø¨ÙˆØ¯ØŒ Ø¬Ø¯ÙˆÙ„ Ø±Ø§ Ù…Ø­Ø¯ÙˆØ¯ Ú©Ù† (Ù…Ø«Ù„Ø§Ù‹ ÙÙ‚Ø· 6) Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ…Ø±ÛŒÙ† Ú©Ù†.
      </div>
    `;
    timeTxt.textContent="â€”";
    clockIcon.textContent="â±";

    $("#againBtn").addEventListener("click", startQuiz);
    $("#reviewBtn").addEventListener("click", ()=>{
      // pick top wrong ones and make a short round
      const keys = Object.keys(state.seen);
      const list = keys.map(k=>{
        const it=state.seen[k];
        const [a,b]=k.split("x").map(Number);
        return {a,b,ans:a*b, w:(it.wrong||0), r:(it.right||0)};
      }).filter(x=>x.w>0).sort((x,y)=> (y.w - x.w) || (x.r - y.r));
      if(list.length===0){
        showToast("ÙØ¹Ù„Ø§Ù‹ Ø§Ø´ØªØ¨Ø§Ù‡ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡! Ø¹Ø§Ù„ÛŒÙ‡.", "Ù…Ø±ÙˆØ±");
        return;
      }
      // create a temp pool from worst 10
      quizPool = list.slice(0,10).map(({a,b,ans})=>({a,b,ans}));
      state.roundTotal = Math.min(10, quizPool.length);
      state.roundDone=0; state.roundRight=0;
      showToast("ğŸ” Ù…Ø±ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡â€ŒÙ‡Ø§ Ø´Ø±ÙˆØ¹ Ø´Ø¯.", "Ù…Ø±ÙˆØ±");
      nextQuizQuestion();
    });
  }

  // ---------- SPEED mode ----------
  function speedTableSet(){
    const v=speedTables.value;
    if(v==="low") return [2,3,4,5];
    if(v==="high") return [6,7,8,9];
    return [2,3,4,5,6,7,8,9];
  }

  function startSpeed(){
    const seconds = parseInt(speedTime.value,10);
    const tables = speedTableSet();
    quizPool = buildPool(tables);
    state.speed.running=true;
    state.speed.right=0;
    state.speed.wrong=0;
    state.speed.endAt = Date.now() + seconds*1000;
    showToast("âš¡ Ø´Ø±ÙˆØ¹ Ø³Ø±Ø¹ØªÛŒ! Ù‡Ø± Ø¯Ø±Ø³Øª = Ø§Ù…ØªÛŒØ§Ø² Ø¨ÛŒØ´ØªØ±.", seconds+"Ø«");
    renderSpeedQuestion();
    if(state.speed.timer) clearInterval(state.speed.timer);
    state.speed.timer = setInterval(()=>{
      if(!state.speed.running) return;
      const left = Math.max(0, state.speed.endAt - Date.now());
      timeTxt.textContent = `Ø²Ù…Ø§Ù†: ${Math.ceil(left/1000)} Ø«`;
      clockIcon.textContent="â³";
      if(left<=0){
        endSpeed();
      }
    }, 120);
  }

  function stopSpeed(){
    if(state.speed.timer) clearInterval(state.speed.timer);
    state.speed.timer=null;
    state.speed.running=false;
  }

  function renderSpeedQuestion(){
    const q = nextQuestionFromPool(quizPool);
    state.current=q;

    stage.innerHTML = `
      <div class="big pop">Ø³Ø±Ø¹ØªÛŒ âš¡</div>
      <p class="subtitle">Ø³Ø±ÛŒØ¹ ÙˆÙ„ÛŒ Ø¯Ù‚ÛŒÙ‚! (Enter Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª)</p>

      <div class="meter">
        <div class="bar" aria-label="Ù†ÙˆØ§Ø± Ø§Ù…ØªÛŒØ§Ø²"><i style="width:${clamp(state.speed.right*6,0,100)}%"></i></div>
        <div class="stat">
          <span class="chip">âœ… Ø¯Ø±Ø³Øª: <b>${state.speed.right}</b></span>
          <span class="chip">âŒ ØºÙ„Ø·: <b>${state.speed.wrong}</b></span>
          <span class="chip">â­ Ø§Ù…ØªÛŒØ§Ø²: <b>${state.score}</b></span>
        </div>
      </div>

      <div class="question">
        <div class="bubble pop">
          <div class="prompt">
            <span class="a">${q.a}</span>
            <span class="sign">Ã—</span>
            <span class="b">${q.b}</span>
            <span class="sign">=</span>
            <span style="opacity:.85">ØŸ</span>
          </div>
          <div class="hint">Ø§Ú¯Ø± Ø§Ø´ØªØ¨Ø§Ù‡ Ø´Ø¯ØŒ Ù‡Ù…Ø§Ù† Ù†ÙˆØ¹ Ø³Ø¤Ø§Ù„ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯.</div>
        </div>

        <div class="answerRow">
          <input id="speedInput" inputmode="numeric" autocomplete="off" placeholder="Ø¬ÙˆØ§Ø¨" />
          <button class="btn good" id="speedCheck">Ø«Ø¨Øª âœ…</button>
          <button class="btn danger" id="speedPass">Ø±Ø¯ Ú©Ù† â­</button>
        </div>
      </div>
    `;

    const input=$("#speedInput");
    input.focus();

    function submit(pass=false){
      if(!state.speed.running) return;
      const v = pass ? null : parseInt((input.value||"").trim(),10);
      const ok = (!pass && !Number.isNaN(v) && v===q.ans);
      markSeen(q, ok);
      if(ok){
        state.speed.right++;
        addScore(14);
        burstConfetti(55);
      }else{
        state.speed.wrong++;
        addScore(2);
      }
      renderSpeedQuestion();
    }

    $("#speedCheck").addEventListener("click", ()=>submit(false));
    $("#speedPass").addEventListener("click", ()=>submit(true));

    document.addEventListener("keydown", speedKeyOnce);
    function speedKeyOnce(ev){
      if(state.mode!=="speed") { document.removeEventListener("keydown", speedKeyOnce); return; }
      if(ev.key==="Enter"){ submit(false); }
    }
  }

  function endSpeed(){
    stopSpeed();
    const right = state.speed.right;
    const bonus = right>=18 ? 80 : right>=12 ? 50 : right>=7 ? 25 : 12;
    addScore(bonus);

    let newRecord=false;
    if(state.bestSpeed==null || right>state.bestSpeed){
      state.bestSpeed=right;
      newRecord=true;
      state.badges += 1;
      persist();
    }
    burstConfetti(newRecord?190:120);

    stage.innerHTML = `
      <div class="big pop">Ù¾Ø§ÛŒØ§Ù† Ø³Ø±Ø¹ØªÛŒ ğŸ</div>
      <p class="subtitle">Ø¯Ø±Ø³Øªâ€ŒÙ‡Ø§: <b>${right}</b> â€” ØºÙ„Ø·â€ŒÙ‡Ø§: <b>${state.speed.wrong}</b></p>

      <div class="trophyRow">
        <div class="trophy"><i>ğŸ</i><div><b>Ø¬Ø§ÛŒØ²Ù‡</b><small>+${bonus} Ø§Ù…ØªÛŒØ§Ø²</small></div></div>
        <div class="trophy"><i>${newRecord?"ğŸ†":"ğŸ“Œ"}</i><div><b>${newRecord?"Ø±Ú©ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯!":"Ø±Ú©ÙˆØ±Ø¯"}</b><small>${state.bestSpeed} Ø¯Ø±Ø³Øª</small></div></div>
        <div class="trophy"><i>ğŸ“ˆ</i><div><b>Ù¾ÛŒØ´Ø±ÙØª</b><small>${progressPercent()}%</small></div></div>
      </div>

      <div class="btnrow" style="justify-content:center; margin-top:16px">
        <button class="btn good" id="speedAgain">Ø¯ÙˆØ¨Ø§Ø±Ù‡ âš¡</button>
        <button class="btn" id="toQuiz">Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ Ú©ÙˆÛŒÛŒØ² ğŸ¯</button>
      </div>
      <div class="footerNote">
        Ù‡Ø¯Ù Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ: 30 Ø«Ø§Ù†ÛŒÙ‡ØŒ Ø­Ø¯Ø§Ù‚Ù„ 10 Ø¯Ø±Ø³Øª. Ø¨Ø¹Ø¯ Ø±Ú©ÙˆØ±Ø¯ Ø±Ø§ Ø¨Ù‡ØªØ± Ú©Ù†.
      </div>
    `;
    timeTxt.textContent="â€”";
    clockIcon.textContent="â±";
    $("#speedAgain").addEventListener("click", startSpeed);
    $("#toQuiz").addEventListener("click", ()=>{
      // switch tab UI too
      $$(".tab").forEach(b=>b.classList.remove("active"));
      $$(".panel").forEach(p=>p.classList.remove("active"));
      $(`.tab[data-tab="quiz"]`).classList.add("active");
      $("#tab-quiz").classList.add("active");
      switchMode("quiz");
    });
    updateTop();
  }

  // ---------- MATCH mode ----------
  function buildPairs(table, count){
    // choose random multipliers 1..10 unique
    const mults = shuffle(Array.from({length:10},(_,i)=>i+1)).slice(0, Math.ceil(count/2));
    const pairs = mults.map(b=>{
      const a = table;
      return {a,b, expr:`${a}Ã—${b}`, ans: a*b};
    });
    return pairs;
  }

  function renderMatch(pairs){
    state.match.selectedL=null;
    state.match.selectedR=null;
    state.match.matched=0;

    const left = shuffle(pairs.map((p,idx)=>({id:idx, text:p.expr})));
    const right = shuffle(pairs.map((p,idx)=>({id:idx, text:String(p.ans)})));

    stage.innerHTML = `
      <div class="big pop">Ù¾Ø§Ø²Ù„ ØªØ·Ø¨ÛŒÙ‚ ğŸ§©</div>
      <p class="subtitle">ÛŒÚ© Â«Ø¹Ø¨Ø§Ø±ØªÂ» Ùˆ ÛŒÚ© Â«Ø¬ÙˆØ§Ø¨Â» Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† ØªØ§ Ø¬ÙØª Ø´ÙˆÙ†Ø¯.</p>

      <div class="meter">
        <div class="bar"><i id="mbar" style="width:0%"></i></div>
        <div class="stat">
          <span class="chip">ğŸ”’ Ø¬ÙØªâ€ŒØ´Ø¯Ù‡: <b id="mmatched">0</b> / ${pairs.length}</span>
          <span class="chip">â­ Ø§Ù…ØªÛŒØ§Ø²: <b>${state.score}</b></span>
        </div>
      </div>

      <div class="matchGrid">
        <div class="col">
          <h3>ğŸŸ¦ Ø¹Ø¨Ø§Ø±Øªâ€ŒÙ‡Ø§</h3>
          <div class="cards" id="leftCards">
            ${left.map(x=>`<div class="mcard" data-side="L" data-id="${x.id}">${x.text}</div>`).join("")}
          </div>
        </div>
        <div class="col">
          <h3>ğŸŸ© Ø¬ÙˆØ§Ø¨â€ŒÙ‡Ø§</h3>
          <div class="cards" id="rightCards">
            ${right.map(x=>`<div class="mcard" data-side="R" data-id="${x.id}">${x.text}</div>`).join("")}
          </div>
        </div>
      </div>

      <div class="footerNote">
        Ø§Ú¯Ø± Ø¯Ø±Ø³Øª Ø¬ÙØª Ø´Ø¯ØŒ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ Ù‚ÙÙ„ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯. Ø§Ú¯Ø± ØºÙ„Ø· Ø´Ø¯ØŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†.
      </div>
    `;

    function updateMatchBar(){
      const pct = Math.round((state.match.matched/pairs.length)*100);
      $("#mbar").style.width = pct+"%";
      $("#mmatched").textContent = state.match.matched;
      if(state.match.matched===pairs.length){
        const bonus = 55 + pairs.length*3;
        addScore(bonus);
        burstConfetti(170);
        showToast("ğŸ‰ Ù¾Ø§Ø²Ù„ Ú©Ø§Ù…Ù„ Ø´Ø¯!", `+${bonus} Ø§Ù…ØªÛŒØ§Ø²`);
        // mark as learned lightly
        pairs.forEach(p=>markSeen(p, true));
      }
    }

    stage.addEventListener("click", (e)=>{
      const c=e.target.closest(".mcard");
      if(!c) return;
      if(c.classList.contains("matched")) return;

      const side=c.dataset.side;
      const id=parseInt(c.dataset.id,10);

      // toggle selection
      if(side==="L"){
        $$("#leftCards .mcard").forEach(x=>x.classList.remove("selected"));
        c.classList.add("selected");
        state.match.selectedL=id;
      }else{
        $$("#rightCards .mcard").forEach(x=>x.classList.remove("selected"));
        c.classList.add("selected");
        state.match.selectedR=id;
      }

      if(state.match.selectedL!=null && state.match.selectedR!=null){
        const ok = state.match.selectedL===state.match.selectedR;

        const l = $(`#leftCards .mcard[data-id="${state.match.selectedL}"]`);
        const r = $(`#rightCards .mcard[data-id="${state.match.selectedR}"]`);

        if(ok){
          l.classList.remove("selected"); r.classList.remove("selected");
          l.classList.add("matched"); r.classList.add("matched");
          state.match.matched++;
          addScore(16);
          burstConfetti(70);
          showToast("âœ… Ø¬ÙØª Ø¯Ø±Ø³Øª!", "+16 Ø§Ù…ØªÛŒØ§Ø²");
        }else{
          addScore(3);
          showToast("âŒ Ø§ÛŒÙ† Ø¬ÙØª Ù†Ø¨ÙˆØ¯. Ø¯ÙˆØ¨Ø§Ø±Ù‡!", "+3 Ø§Ù…ØªÛŒØ§Ø²");
          stage.classList.remove("shake"); void stage.offsetWidth; stage.classList.add("shake");
          setTimeout(()=>{
            l.classList.remove("selected");
            r.classList.remove("selected");
          }, 250);
        }
        state.match.selectedL=null;
        state.match.selectedR=null;
        updateMatchBar();
      }
    }, {once:false});
  }

  function startMatch(){
    const t=parseInt(matchTable.value,10);
    const c=parseInt(matchCount.value,10);
    const pairs = buildPairs(t, c);
    state.match.pairs=pairs;
    renderMatch(pairs);
    timeTxt.textContent = `Ø¬Ø¯ÙˆÙ„ ${t}`;
    clockIcon.textContent="ğŸ§©";
    showToast("ğŸ§© Ù¾Ø§Ø²Ù„ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯!", `Ø¬Ø¯ÙˆÙ„ ${t}`);
  }

  // ---------- teacher hints ----------
  teacherBtn.addEventListener("click", ()=>{
    const tips = `
      <div class="big pop">Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø³Ø±ÛŒØ¹ Ø§Ø¬Ø±Ø§ ğŸ‘©â€ğŸ«</div>
      <p class="subtitle">Û³ Ø§ÛŒØ¯Ù‡ Ø¨Ø±Ø§ÛŒ Ú©Ù„Ø§Ø³ Ø³ÙˆÙ… (Ú©ÙˆØªØ§Ù‡ Ùˆ Ø¹Ù…Ù„ÛŒ)</p>
      <div class="bubble pop" style="margin: 0 auto; width:min(720px, 100%);">
        <div class="hint" style="font-size:13px; line-height:2; color:rgba(255,255,255,.82)">
          <b>Û±) Ø´Ø±ÙˆØ¹ Ø¨Ø§ Ø§Ù„Ú¯ÙˆÙ‡Ø§:</b> Ø¬Ø¯ÙˆÙ„ 2 Ùˆ 5 Ø±Ø§ Ø§ÙˆÙ„ Ø¨Ú¯ÛŒØ±ÛŒØ¯ (Ø§Ù„Ú¯ÙˆÛŒ Ø²ÙˆØ¬/Ù¾Ø§ÛŒØ§Ù† 0 ÛŒØ§ 5).<br>
          <b>Û²) Ø¨Ø§Ø²ÛŒ ØªÛŒÙ…ÛŒ:</b> Ú©Ù„Ø§Ø³ Ø±Ø§ Ø¯Ùˆ ØªÛŒÙ… Ú©Ù†ÛŒØ¯. Ù‡Ø± Ø¬ÙˆØ§Ø¨ Ø¯Ø±Ø³Øª = ÛŒÚ© Ø§Ù…ØªÛŒØ§Ø². Ù‡Ø± Ø§Ø´ØªØ¨Ø§Ù‡ = ÙØ±ØµØª ØªÛŒÙ… Ù…Ù‚Ø§Ø¨Ù„.<br>
          <b>Û³) ØªÙ‚ÙˆÛŒØª Ø­Ø§ÙØ¸Ù‡:</b> Ø¨Ø¹Ø¯ Ø§Ø² Ù‡Ø± 10 Ø³Ø¤Ø§Ù„ØŒ 2 Ø³Ø¤Ø§Ù„ Ø§Ø² Ø§Ø´ØªØ¨Ø§Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Â«Ù…Ø±ÙˆØ±Â» Ú©Ù†ÛŒØ¯ ØªØ§ ØªØ«Ø¨ÛŒØª Ø´ÙˆØ¯.
        </div>
      </div>
      <div class="btnrow" style="justify-content:center; margin-top:14px">
        <button class="btn primary" id="goBack">Ø¨Ø±Ú¯Ø´Øª</button>
      </div>
    `;
    stage.innerHTML = tips;
    $("#goBack").addEventListener("click", ()=>{
      if(state.mode==="quiz") renderQuizIntro();
      else if(state.mode==="speed") renderSpeedIntro();
      else renderMatchIntro();
    });
    showToast("Ø±Ø§Ù‡Ù†Ù…Ø§ Ø¨Ø§Ø² Ø´Ø¯.", "Ù…Ø¹Ù„Ù…");
  });

  // ---------- buttons wiring ----------
  startQuizBtn.addEventListener("click", ()=>{ switchMode("quiz"); startQuiz(); });
  resetBtn.addEventListener("click", ()=>{
    localStorage.removeItem(storeKey);
    location.reload();
  });

  startSpeedBtn.addEventListener("click", ()=>{ switchMode("speed"); startSpeed(); });
  stopSpeedBtn.addEventListener("click", ()=>{
    if(state.mode!=="speed") return;
    endSpeed();
  });

  startMatchBtn.addEventListener("click", ()=>{ switchMode("match"); startMatch(); });
  reshuffleMatchBtn.addEventListener("click", ()=>{
    if(state.mode!=="match" || !state.match.pairs.length){
      showToast("Ø§ÙˆÙ„ Ù¾Ø§Ø²Ù„ Ø±Ø§ Ø¨Ø³Ø§Ø².", "Ù¾Ø§Ø²Ù„");
      return;
    }
    renderMatch(state.match.pairs);
    showToast("ğŸ² Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¯Ø±Ù‡Ù…â€ŒØ±ÛŒØ²ÛŒ Ø´Ø¯.", "Ù¾Ø§Ø²Ù„");
  });

  // keyboard quick actions
  document.addEventListener("keydown", (e)=>{
    if(e.ctrlKey || e.metaKey || e.altKey) return;
    if(e.code==="Space"){
      if(state.mode==="quiz" && state.allowNext){
        e.preventDefault();
        nextQuizQuestion();
      }
    }
  });

  // init
  updateTop();
  switchMode("quiz");
  showToast("Ø³Ù„Ø§Ù…! ÛŒÚ© Ø­Ø§Ù„Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† Ùˆ Ø´Ø±ÙˆØ¹ Ú©Ù†.", "Ø´Ø±ÙˆØ¹");

})();
</script>
</body>
  </html>
